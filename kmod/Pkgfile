# Description: Kernel module utilities and library
# URL: https://git.kernel.org/?p=utils/kernel/kmod/kmod.git
# Maintainer: CRUX System Team, core-ports at crux dot nu
#Â Arch Maintainer: Jose Beneyto, sepen at crux-arm dot nu
# Depends on:

name=kmod
version=34.2
release=1
source=(https://www.kernel.org/pub/linux/utils/kernel/$name/$name-$version.tar.xz)

build() {
    meson setup build $name-$version \
        --prefix=/usr \
        --bindir=/bin \
        --sbindir=/sbin \
        --libdir=/usr/lib \
        --sysconfdir=/etc \
        --buildtype=plain \
        --wrap-mode=nodownload \
        -D b_lto=true \
        -D b_pie=true \
        -D dlopen=all \
        -D docs=false \
        -D manpages=false \
        -D bashcompletiondir=no \
        -D fishcompletiondir=no \
        -D zshcompletiondir=no

    meson compile -C build -j ${JOBS:-1}
    DESTDIR=$PKG meson install -C build

    install -d $PKG/lib
    mv $PKG/usr/lib/libkmod.so.* $PKG/lib
    ln -sf ../../lib/$(readlink $PKG/usr/lib/libkmod.so) $PKG/usr/lib/libkmod.so
}
